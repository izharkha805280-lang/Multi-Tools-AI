<script>
        const speedDisplay = document.getElementById('speed-display');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const meter = document.getElementById('meter');

        // 1.5MB Image (Perfect for both slow & fast net)
        const imageAddr = "https://upload.wikimedia.org/wikipedia/commons/b/b9/Piz_igls_main.jpg"; 
        const downloadSize = 1500000; // Approx 1.5 MB in bytes

        function startTest() {
            // 1. Reset UI
            startBtn.disabled = true;
            startBtn.innerText = "Testing...";
            statusText.innerText = "Connecting to server...";
            statusText.style.color = "var(--text-color)";
            speedDisplay.innerText = "0.0";
            
            // 2. Fake Animation (Looks cool while loading)
            let fakeSpeed = 0;
            const animInterval = setInterval(() => {
                fakeSpeed = Math.floor(Math.random() * 20) + 1; 
                speedDisplay.innerText = fakeSpeed;
                updateMeter(fakeSpeed);
            }, 150);

            // 3. Start Real Download
            const startTime = (new Date()).getTime();
            const download = new Image();
            
            // Logic jab download khatam ho
            download.onload = function () {
                clearInterval(animInterval); // Fake animation roko
                
                const endTime = (new Date()).getTime();
                const duration = (endTime - startTime) / 1000; // Seconds mein time
                
                // Speed Formula: (Bits / Seconds) / (1024*1024) = Mbps
                const bitsLoaded = downloadSize * 8;
                const speedBps = bitsLoaded / duration;
                const speedMbps = (speedBps / (1024 * 1024)).toFixed(2);
                
                showFinalResult(speedMbps);
            };

            // Error Handling
            download.onerror = function () {
                clearInterval(animInterval);
                startBtn.disabled = false;
                startBtn.innerText = "Retry";
                statusText.innerText = "Error! Check internet connection.";
                statusText.style.color = "red";
            };

            // ðŸ”´ IMPORTANT: Cache Buster Logic
            // ?n=Math.random() lagane se browser har baar naya download karega
            download.src = imageAddr + "?n=" + Math.random();
        }

        function showFinalResult(speed) {
            speedDisplay.innerText = speed;
            updateMeter(speed);
            
            // Message based on speed
            let msg = "";
            if(speed < 1) msg = "Slow (2G/3G)";
            else if(speed < 10) msg = "Average (4G)";
            else msg = "Fast (WiFi/5G)";

            statusText.innerText = `âœ… Speed: ${speed} Mbps (${msg})`;
            statusText.style.color = "#00b894";
            
            startBtn.disabled = false;
            startBtn.innerText = "Test Again";
        }

        function updateMeter(value) {
            // Visual Circle - Max limit 20 for visual purpose
            const percent = Math.min(value, 20) * 5; // 20Mbps = 100% rotation
            const degrees = (percent / 100) * 360;
            meter.style.background = `conic-gradient(var(--primary-color) ${degrees}deg, #ddd ${degrees}deg)`;
        }
</script>
